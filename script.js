      // Add before the existing script code
      const translations = {
        en: {
          title: "Nuestra América",
          themeButton: "Toggle Theme",
          randomQuoteButton: "Random Quote",
          highlightLabel: "Highlight Color:",
          noteLabel: "Note Color:",
          exportButton: "Export to PDF",
          createPostit: "Create Post-it",
          annotations: "Annotations",
          languageButton: "Español"
        },
        es: {
          title: "Nuestra América",
          themeButton: "Cambiar Tema",
          randomQuoteButton: "Cita Aleatoria",
          highlightLabel: "Color de Resaltado:",
          noteLabel: "Color de Nota:",
          exportButton: "Exportar a PDF",
          createPostit: "Crear Nota",
          annotations: "Anotaciones",
          languageButton: "English"
        }
      };

      const contentTranslations = {
        en: {
          paragraphs: [
            "Our America",
            "The conceited villager believes the entire world to be his village. Provided that he can be mayor, humiliate the rival who stole his sweetheart, or add to the savings in his strongbox, he considers the universal order good, unaware of those giants with seven-league boots who can crush him underfoot, or of the strife in the heavens between comets that go through the air asleep, gulping down worlds. What remains of the village in America must rouse itself. These are not the times for sleeping in a nightcap, but with weapons for a pillow, like the warriors of Juan de Castellanos: weapons of the mind, which conquer all others. Barricades of ideas are worth more than barricades of stones.",
            "There is no prow that can cut through a cloudbank of ideas. A powerful idea, waved before the world at the proper time, can stop a squadron of iron-clad ships, like the mystical flag of the Last Judgement. Nations that do not know one another should quickly become acquainted, as men who are to fight a common enemy. Those who shake their fists, like jealous brothers coveting the same tract of land, or like the modest cottager who envies the esquire his mansion, should clasp hands and become one. Those who use the authority of a criminal tradition to lop off the hands of their defeated brother with a sword stained with his own blood, ought to return the lands to the brother already punished sufficiently, if they do not want the people to call them robbers. The honest man does not absolve himself of debts of honor with money, at so much a slap. We can no longer be a people of leaves, living in the air, our foliage heavy with blooms and crackling or humming at the whim of the sun's caress, or buffeted and tossed by the storms. The trees must form ranks to keep the giant with seven-league boots from passing! It is the time of mobilization, of marching together, and we must go forward in close ranks, like silver in the veins of the Andes.",
            "Only those born prematurely are lacking in courage. Those without faith in their country are seven-month weaklings. Because they have not courage, they deny it to the others. Their puny arms—with bracelets and hands with painted nails, arms of Paris or Madrid—can hardly reach the bottom limb, and they claim the tall tree to be unclimbable. The ships should be loaded with those harmful insects that gnaw at the bone of the country that nourishes them. If they are Parisians or from Madrid, let them go to the Prado, to boast around, or to Tortoni’s, in high hats. Those carpenter's sons who are ashamed that their fathers are carpenters! Those born in America who are ashamed of the mother that reared them, because she wears an Indian apron, and who disown their sick mothers—the scoundrels, abandoning her on her sickbed! Then who is a real man? He who stays with his mother and nurses her in her illness, or he who puts her to work out of sight, and lives at her expense on decadent lands, sporting fancy neckties, cursing the womb that carried him, displaying the sign of the traitor on the back of his paper frockcoat? These sons of our America, which will be saved by its Indians in blood and is growing better; these deserters who take up arms in the army of a North America that drowns its Indians in blood and is growing worse! These delicate creatures who are men but are unwilling to do men's work! The Washington who made this land for them, did he not go to live with the English, at a time when he saw them fighting against his own country. These unbelievers of honor drag honor over foreign soil like their counterparts in the French Revolution with their dancing, their affections, their drawling speech!",
            "For in what lands can men take more pride than in our long-suffering American republics, raised up among the silent Indian masses by the bleeding arms of a hundred apostles, to the sound of battle between the book and the processional candle? Never in history have such advanced and united nations been forged in so short a time from such disorganized elements. The presumptuous man feels that the earth was made to serve as his pedestal, because he happens to have a facile pen or colourful speech, and he accuses his native land of being worthless and beyond redemption because its virgin jungles fail to provide him with a constant means of travelling over the world, driving Persian ponies and lavishing champagne like a tycoon. The incapacity does not lie with the emerging country in quest of suitable forms and utilitarian greatness; it lies rather with those who attempt to rule nations of a unique and violent character by means of laws inherited from four centuries of freedom in the United States and nineteen centuries of monarchy in France. A decree by Hamilton does not halt the charge of the plainsman's horse. A phrase by Sieyès does nothing to quicken the stagnant blood of the Indian race. To govern well, one must see things as they are. And the able governor in America is not the one who knows how to govern the Germans or the French; he must know the elements that make up his own country, and how to bring them together, using methods and institutions originating within the country, to reach that desirable state where each man can attain self-realization and all may enjoy the abundance that Nature has bestowed on every citizen. Government must originate in the country. The spirit of government must be that of the country. Its structure must conform to rules appropriate to the country. Good government is nothing more than the balance of the country's natural elements.",
            "That is why in America the imported book has been conquered by the natural man. Natural men have conquered learned and artificial men. The native half-breed has conquered the exotic Creole. The struggle is not between civilization and barbarity, but between false erudition and Nature. The natural man is good, and he respects and rewards superior intelligence as long as his humility is not turned against him, or he is not offended by being disregarded—something the natural man never forgives, prepared as he is to forcibly regain the respect of whoever has wounded his pride or threatened his interests. It is by conforming with these disdained native elements that the tyrants of America have climbed to power, and have fallen as soon as they betrayed them. Republics have paid with oppression for their inability to recognize the true elements of their countries, to derive from them the right kind of government, and to govern accordingly. In a new nation a government means a creator.",
            "In nations composed of both cultured and uncultured elements, the uncultured will govern because it is their habit to attack and resolve doubts with their fists in cases where the cultured have failed in the art of governing. The uncultured masses are lazy and timid in the realm of intelligence, and they want to be governed well. But if the government hurts them, they shake it off and govern themselves. How can the universities produce governors if not a single university in America teaches the rudiments of the art of government, the analysis of elements peculiar to the peoples of America? The young go out into the world wearing Yankee or French spectacles, hoping to govern a people they do not know. In the political race entrance should not go for the best ode, but for the best study of the political factors of one's country. Newspapers, universities, and schools should encourage the study of the country's pertinent components. To know them is sufficient, without mincing words; for whoever brushes aside even a part of the truth, whether through intention or oversight, is doomed to fall. The truth is built without it. It is easier to resolve our problem knowing its components than to resolve it without knowing them. Along comes the natural man, strong and indignant, and he topples all the justice accumulated from books because he has not been governed in accordance with the obvious needs of the country. Knowing is what counts. To know one's country and govern it with that knowledge is the only way to free it from tyranny. The European university must bow to the American university. The history of America, from the Incas to the present, must be taught in clear detail and to the letter, even if the archons of Greece are overlooked. Our Greece must take priority over the Greece which is not ours. We need it more. Nationalist statement must replace foreign statement. Let the world be grafted onto our republics, but the trunk must be our own. And let the vanquished pedant hold his tongue, for there are no lands in which a man may take greater pride than in our long-suffering American republics.",
            "With the rosary as our guide, our heads white and our bodies mottled, both Indians and Creoles, we fearlessly entered the world of nations. We set out to conquer freedom under the banner of the virgin. A priest, a few lieutenants, and a woman raised the Republic of Mexico onto the shoulders of the Indians. A few heroic students, instructed in French liberty by a Spanish cleric, made Central America rise in revolt against Spain under a Spanish general. In monarchic garb emblazoned with the sun, the Venezuelans to the north and the Argentineans to the south began building nations. When the heroes clashed and the continent was about to rock, one of them—and not the lesser—handed the reins to the other. And since heroism in times of peace is rare because it is not as glorious as in times of war, it is easier to govern when feelings are exalted and united than after a battle, when divisive, arrogant, exotic, or ambitious thinking emerges. The forces routed in the epic struggle—with the feline cunning of the species, and using the weight of realities—were undermining the new structure which comprised both the rough-and-ready, unique regions of our half-breed America and the silk-stockinged and frockcoated people of Paris beneath the flag of freedom and reason borrowed from nations skilled in the arts of government. The hierarchical constitution of the colonies resisted the democratic organization of the republics. The cravatted capitals left their country boots in the vestibule. The bookworm redeemers failed to realize that the revolution succeeded because it came from the soul of the nation; they had to govern with that soul and not without or against it. America began to suffer, and still suffers, from the tiresome task of reconciling the hostile and discordant elements it inherited from the despotic and perverse colonizer, and the imported methods and ideas which have been retarding logical government because they are lacking in local realities. Thrown out of gear for three centuries by a power which denied men the right to use their reason, the continent disregarded or closed its ears to the unlettered throngs that helped bring it to redemption, and embarked on a government based on reason—a reason belonging to all for the common good, not the university brand of reason over the peasant brand. The problem of independence did not lie in a change of forms but in a change of spirit.",
            "It was imperative to make common cause with the oppressed, in order to secure a new system opposed to the ambitions and governing habits of the oppressors. The tiger, frightened by gunfire, returns at night to his prey. He dies with his eyes shooting flames and his claws unsheathed. He cannot be heard coming because he approaches with velvet tread. When the prey awakens, the tiger is already upon it. The colony lives on the republic, and our America is saving itself from its enormous mistakes—the pride of its capital cities, the blind triumph of a scorned peasantry, the excessive influx of foreign ideas and formulas, the wicked and unpolitical disdain for the aboriginal race—because of the higher virtue, enriched with necessary blood, or a republic struggling against a colony. The tiger lurks behind every tree, lying in wait at every turn. He will die with his claws unsheathed and his eyes shooting flames.",
            "But \"these countries will be saved\", as was announced by the Argentinean Rivadavia, whose only sin was being a gentleman in these rough-and-ready times. A man does not sheathe a machete in a silken scabbard, nor can he lay aside the short lance merely because he is angered and stands at the door of Iturbide’s Congress, \"demanding that the fair-haired one be named emperor\". These countries will be saved because a genius for moderation, found in the serene harmony of Nature, seems to prevail in the continent of light, where there emerges a new real man schooled for these real times in the critical philosophy of guesswork and phalanstery that saturated the previous generation.",
            "We were a phenomenon with the chest of an athlete, the hands of a dandy, and the brain of a child. We were a masquerader in English breeches, Parisian vest, North American jacket, and Spanish cap. The Indian hovered near us in silence, and went off to the hills to baptize his children. The Negro was seen pouring out the songs of his heart at night, alone and unrecognized among the rivers and wild animals. The peasant, the creator, turned in blind indignation against the disdainful city, against his own child. As for us, we were nothing but epaulets and a professor’s gown in countries that came into the world wearing hemp sandals and headbands. It would have been the mark of genius to couple the headband and the professor’s gown with the founding fathers’ generosity and courage, to rescue the Indian, to make a place for the competent Negro, to fit liberty to the body of those who rebelled and conquered for it. We were left with the hearer, the general, the scholar, and the sinecured. The angelic young, as if caught in the tentacles of an octopus, lunged heavenward only to fall back, crowned with clouds in sterile glory. The native, driven by instinct, swept away the golden staffs of office in blind triumph. Neither the Europeans nor the Yankees could provide the key to the Spanish American riddle. Hate was attempted, and every year the countries amounted to less. Exhausted by the senseless struggle between the book and the lance, between reason and the processional candle, between the city and the country, weary of the impossible rule by rival urban cliques over the natural nation—tempestuous or inert by turns—we were almost unconsciously led to try love. Nations stand up and greet one another. \"What are we?\" is the mutual question, and little by little they furnish answers. When a problem arises in Cojímar, they do not seek its solution in Danzig. The frockcoated are still French, but thought begins to be American. The youth of America are rolling up their sleeves, digging their hands into the dough, and making it rise with the sweat of their brows. They realize that there is too much imitation, and that creation holds the key to salvation. \"Create\" is the password of this generation. The wine is made from plantain, but even if it turns sour, it is our own wine! That a country's form of government must be in keeping with its natural elements is a foregone conclusion. Absolute ideas must take relative forms if they are not to fail because of an error in form. Freedom, to be viable, has to be sincere and complete. If a republic refuses to open its arms to all and move ahead with all, it dies. The tiger within sneaks in through the crack; so does the tiger from without. The general holds back his cavalry to a pace that suits his infantry, for if his infantry is left behind, the cavalry will be surrounded by the enemy. Politics and strategy are one. Nations should live in an atmosphere of self-criticism because it is healthy, but always with one heart and one mind. Stoop to the unhappy, and lift them up in your arms! Thaw out frozen America with the fire of your hearts! Make the natural blood of the nation course vigorously through their veins! The new Americans are on their feet, saluting one another from nation to nation, the eyes of the laborers shining with joy. The natural statesman arises, schooled in the direct study of Nature. He reads to apply his knowledge, not to imitate. Economists study the problems at their point of origin. Speakers begin a policy of moderation. Playwrights bring native characters to the stage. Academies discuss practical subjects. Poetry shears off its Zorrilla-like locks and hangs its red vest on the glorious tree. Selective and sparkling prose is filled with ideas. In the Indian republics, the governors are learning Indian.",
            "America is escaping all its dangers. Some of the republics are still beneath the sleeping octopus, but others, under the law of averages, are draining their land with sublime and furious haste, as if to make up for centuries lost. Still others, forgetting that Juárez went about in a carriage drawn by mules, hitch their carriages to the wind, their coachmen like soap bubbles. Poisonous luxury, the enemy of freedom, corrupts the frivolous and opens the door to the foreigner. In others, where independence is threatened, an epic spirit heightens their manhood. Still others spawn an army capable of devouring them in voracious wars. But perhaps our America is running another risk that does not come from itself but from the difference in origins, methods, and interests between the two halves of the continent, and the time is near at hand when an enterprising and vigorous people who scorn and ignore our America will even so approach it and demand a close relationship. And since strong nations—self-made by law and shotgun—love strong nations and band together; since the time of madness and ambition—from which North America may be freed by the predominance of the purest elements in its blood, or on which it may be launched by its vindictive and sordid masses, its tradition of expansion, or the ambition of some powerful leader—is not so near at hand, even to the most timorous eye, there is no time for the test of discreet and unwavering pride that could confront and dissuade it; since its good name as a republic in the eyes of the world's perceptive nations puts upon North America a restraint that cannot be taken away by childish provocations or pompous arrogance or parricidal discords among our American nations—the pressing need of our America is to show itself as it is, one in spirit and intent, swift conquerors of a suffocating past, stained only by the enriching blood drawn from the scarfs left upon us by our masters. The scorn of our formidable neighbor who does not know us is our America’s greatest danger. And since the day of the visit is near, it is imperative that our neighbor know us, and soon, so that it will not scorn us. Through ignorance it might even lay hands on us. Once it does know us, it will remove its hands out of respect. One must have faith in the best in men and distrust the worst. One must allow the best to be shown so that it reveals and prevails over the worst. Nations should have a pillory for whoever stirs up useless hate, and another for whoever fails to tell them the truth in time.",
            "There can be no racial animosity, because there are no races. The theorists and feeble thinkers string together and warm over the bookshelf the races which the well-disposed observer and the fair-minded traveller vainly seek in the justice of Nature, where man's universal identity springs forth from triumphant love and the turbulent hunger for life. The soul, equal and eternal, emanates from bodies of different shapes and colors. Whoever foments and spreads antagonism and hate between the races sins against humanity. But as nations take shape among different nations, there is a condensation of vital and individual characteristics of thought, habit, expansion and conquest, vanity and greed which could—from the latent state of national concern, and in periods of internal disorder or the rapidity with which the country's character has been accumulating—be turned into a serious threat for the weak and isolated neighbouring countries, declared by the strong country to be inferior and perishable. The thought is father to the deed. And one must not attribute, through a provincial antipathy, a fatal and inborn wickedness to the continent’s fair–skinned nation simply because it does not speak our language, nor see the world as we see it, nor resemble us in its political defects—so different from ours—nor favourably regard the excitable, dark–skinned people, or look charitably, from its still uncertain eminence, upon those less favored by history who climb the road of republicanism by heroic stages. The self–evident facts of the problem should not be obscured, because the problem can be resolved, for peace of centuries to come, by appropriate study and by tacit and immediate union in the continental spirit. With a single voice the hymn is already being sung; the present generation is carrying industrious America along the road enriched by their sublime fathers; from Rio Grande to the strains of Magellan, the Great Semi, astride its condor, spread the seed of the new America over the romantic nations of the continent and the sorrowful islands of the sea!"
          ]
        },
        es: {
          paragraphs: [
            "Nuestra América",
            "Cree el aldeano vanidoso que el mundo entero es su aldea, y con tal que él quede de alcalde, o le mortifique al rival que le quitó la novia, o le crezcan en la alcancía los ahorros, ya da por bueno el orden universal, sin saber de los gigantes que llevan siete leguas en las botas y le pueden poner la bota encima, ni de la pelea de los cometas en el cielo, que van por el aire dormido engullendo mundos. Lo que quede de aldea en América ha de despertar. Estos tiempos no son para acostarse con el pañuelo a la cabeza, sino con las armas de almohada, como los varones de Juan de Castellanos: las armas del juicio, que vencen a las otras. Trincheras de ideas valen más que trincheras de piedra.",
            "No hay proa que taje una nube de ideas. Una idea enérgica, flameada a tiempo ante el mundo, para, como la bandera mística del juicio final, a un escuadrón de acorazados. Los pueblos que no se conocen han de darse prisa para conocerse, como quienes van a pelear juntos. Los que se enseñan los puños, como hermanos celosos, que quieren los dos la misma tierra, o el de casa chica, que le tiene envidia al de casa mejor, han de encajar, de modo que sean una las dos manos. Los que, al amparo de una tradición criminal, cercenaron, con el sable tinto en la sangre de sus mismas venas, la tierra del hermano vencido, del hermano castigado más allá de sus culpas, si no quieren que les llame el pueblo ladrones, devuélvanle sus tierras al hermano. Las deudas del honor no las cobra el honrado en dinero, a tanto por la bofetada. Ya no podemos ser el pueblo de hojas, que vive en el aire, con la copa cargada de flor, restallando o zumbando, según la acaricie el capricho de la luz, o la tundan y talen las tempestades; ¡los árboles se han de poner en fila, para que no pase el gigante de las siete leguas! Es la hora del recuento, y de la marcha unida, y hemos de andar en cuadro apretado, como la plata en las raíces de los Andes.",
            "A los sietemesinos sólo les faltará el valor. Los que no tienen fe en su tierra son hombres de siete meses. Porque les falta el valor a ellos, se lo niegan a los demás. No les alcanza al árbol difícil el brazo canijo, el brazo de uñas pintadas y pulsera, el brazo de Madrid o de París, y dicen que no se puede alcanzar el árbol. Hay que cargar los barcos de esos insectos dañinos, que le roen el hueso a la patria que los nutre. Si son parisienses o madrileños, vayan al Prado, de faroles, o vayan a Tortoni, de sorbetes. ¡Estos hijos de carpintero, que se avergüenzan de que su padre sea carpintero! ¡Estos nacidos en América, que se avergüenzan, porque llevan delantal indio, de la madre que los crió, y reniegan, ¡bribones!, de la madre enferma, y la dejan sola en el lecho de las enfermedades! Pues, ¿quién es el hombre?, ¿el que se queda con la madre, a curarle la enfermedad, o el que la pone a trabajar donde no la vean, y vive de su sustento en las tierras podridas, con el gusano de corbata, maldiciendo del seno que lo cargó, paseando el letrero de traidor en la espalda de la casaca de papel? ¡Estos hijos de nuestra América, que ha de salvarse con sus indios, y va de menos a más; estos desertores que piden fusil en los ejércitos de la América del Norte, que ahoga en sangre a sus indios, y va de más a menos! ¡Estos delicados, que son hombres y no quieren hacer el trabajo de hombres! Pues el Washington que les hizo esta tierra ¿se fue a vivir con los ingleses, a vivir con los ingleses en los años en que los veía venir contra su tierra propia? ¡Estos \"increíbles\" del honor, que lo arrastran por el suelo extranjero, como los increíbles de la Revolución francesa, danzando y relamiéndose, arrastraban las erres!",
            "Ni ¿en qué patria puede tener un hombre más orgullo que en nuestras repúblicas dolorosas de América, levantadas entre las masas mudas de indios, al ruido de pelea del libro con el cirial, sobre los brazos sangrientos de un centenar de apóstoles? De factores tan descompuestos, jamás, en menos tiempo histórico, se han creado naciones tan adelantadas y compactas. Cree el soberbio que la tierra fue hecha para servirle de pedestal, porque tiene la pluma fácil o la palabra de colores, y acusa de incapaz e irremediable a su república nativa, porque no le dan sus selvas nuevas modo continuo de ir por el mundo de gamonal famoso, guiando jacas de Persia y derramando champaña. La incapacidad no está en el país naciente, que pide formas que se le acomoden y grandeza útil, sino en los que quieren regir pueblos originales, de composición singular y violenta, con leyes heredadas de cuatro siglos de práctica libre en los Estados Unidos, de diecinueve siglos de monarquía en Francia. Con un decreto de Hamilton no se le para la pechada al potro del llanero. Con una frase de Sieyés no se desestanca la sangre cuajada de la raza india. A lo que es, allí donde se gobierna, hay que atender para gobernar bien; y el buen gobernante en América no es el que sabe cómo se gobierna el alemán o el francés, sino el que sabe con qué elementos está hecho su país, y cómo puede ir guiándolos en junto, para llegar, por métodos e instituciones nacidas del país mismo, a aquel estado apetecible donde cada hombre se conoce y ejerce, y disfrutan todos de la abundancia que la Naturaleza puso para todos en el pueblo que fecundan con su trabajo y defienden con sus vidas. El gobierno ha de nacer del país. El espíritu del gobierno ha de ser el del país. La forma del gobierno ha de avenirse a la constitución propia del país. El gobierno no es más que el equilibrio de los elementos naturales del país.",
            "Por eso el libro importado ha sido vencido en América por el hombre natural. Los hombres naturales han vencido a los letrados artificiales. El mestizo autóctono ha vencido al criollo exótico. No hay batalla entre la civilización y la barbarie, sino entre la falsa erudición y la naturaleza. El hombre natural es bueno, y acata y premia la inteligencia superior, mientras ésta no se vale de su sumisión para dañarle, o le ofende prescindiendo de él, que es cosa que no perdona el hombre natural, dispuesto a recobrar por la fuerza el respeto de quien le hiere la susceptibilidad o le perjudica el interés. Por esta conformidad con los elementos naturales desdeñados han subido los tiranos de América al poder; y han caído en cuanto les hicieron traición. Las repúblicas han purgado en las tiranías su incapacidad para conocer los elementos verdaderos del país, derivar de ellos la forma de gobierno y gobernar con ellos. Gobernante, en un pueblo nuevo, quiere decir creador.",
            "En pueblos compuestos de elementos cultos e incultos, los incultos gobernarán, por su hábito de agredir y resolver las dudas con la mano, allí donde los cultos no aprendan el arte del gobierno. La masa inculta es perezosa, y tímida en las cosas de la inteligencia, y quiere que la gobiernen bien; pero si el gobierno le lastima, se lo sacude y gobierna ella. ¿Cómo han de salir de las Universidades los gobernantes, si no hay Universidad en América donde se enseñe lo rudimentario del arte del gobierno, que es el análisis de los elementos peculiares de los pueblos de América? A adivinar salen los jóvenes al mundo, con antiparras yanquis o francesas, y aspiran a dirigir un pueblo que no conocen. En la carrera de la política habría de negarse la entrada a los que desconocen los rudimentos de la política. El premio de los certámenes no ha de ser para la mejor oda, sino para el mejor estudio de los factores del país en que se vive. En el periódico, en la cátedra, en la academia, debe llevarse adelante el estudio de los factores reales del país. Conocerlos basta, sin vendas ni ambages: porque el que pone de lado, por voluntad u olvido, una parte de la verdad, cae a la larga por la verdad que le faltó, que crece en la negligencia, y derriba lo que se levanta sin ella. Resolver el problema después de conocer sus elementos, es más fácil que resolver el problema sin conocerlos. Viene el hombre natural, indignado y fuerte, y derriba la justicia acumulada de los libros, porque no se la administra en acuerdo con las necesidades patentes del país. Conocer es resolver. Conocer el país, y gobernarlo conforme al conocimiento, es el único modo de librarlo de tiranías. La universidad europea ha de ceder a la universidad americana. La historia de América, de los incas a acá, ha de enseñarse al dedillo, aunque no se enseñe la de los arcontes de Grecia. Nuestra Grecia es preferible a la Grecia que no es nuestra. Nos es más necesaria. Los políticos nacionales han de reemplazar a los políticos exóticos. Injértese en nuestras Repúblicas el mundo; pero el tronco ha de ser el de nuestras Repúblicas. Y calle el pedante vencido; que no hay patria en que pueda tener el hombre más orgullo que en nuestras dolorosas repúblicas americanas.",
            "Con los pies en el rosario, la cabeza blanca y el cuerpo pinto de indio y criollo, venimos, denodados, al mundo de las naciones. Con el estandarte de la Virgen salimos a la conquista de la libertad. Un cura, unos cuantos tenientes y una mujer alzan en México la república en hombros de los indios. Un canónigo español, a la sombra de su capa, instruye en la libertad francesa a unos cuantos bachilleres magníficos, que ponen de jefe de Centro América contra España al general de España. Con los hábitos monárquicos, y el Sol por pecho, se echaron a levantar pueblos los venezolanos por el Norte y los argentinos por el Sur. Cuando los dos héroes chocaron, y el continente iba a temblar, uno, que no fue el menos grande, volvió riendas. Y como el heroísmo en la paz es más escaso, porque es menos glorioso que el de la guerra; como al hombre le es más fácil morir con honra que pensar con orden; como gobernar con los sentimientos exaltados y unánimes es más hacedero que dirigir, después de la pelea, los pensamientos diversos, arrogantes, exóticos o ambiciosos; como los poderes arrollados en la arremetida épica zapaban, con la cautela felina de la especie y el peso de lo real, el edificio que había izado, en las comarcas burdas y singulares de nuestra América mestiza, en los pueblos de pierna desnuda y casaca de París, la bandera de los pueblos nutridos de savia gobernante en la práctica continua de la razón y de la libertad; como la constitución jerárquica de las colonias resistía la organización democrática de la República, o las capitales de corbatín dejaban en el zaguán al campo de bota-de-potro, o los redentores bibliógenos no entendieron que la revolución que triunfó con el alma de la tierra, desatada a la voz del salvador, con el alma de la tierra había de gobernar, y no contra ella ni sin ella, entró a padecer América, y padece, de la fatiga de acomodación entre los elementos discordantes y hostiles que heredó de un colonizador despótico y avieso, y las ideas y formas importadas que han venido retardando, por su falta de realidad local, el gobierno lógico. El continente descoyuntado durante tres siglos por un mando que negaba el derecho del hombre al ejercicio de su razón, entró, desatendiendo o desoyendo a los ignorantes que lo habían ayudado a redimirse, en un gobierno que tenía por base la razón; la razón de todos en las cosas de todos, y no la razón universitaria de uno sobre la razón campestre de otros. El problema de la independencia no era el cambio de formas, sino el cambio de espíritu.",
            "Con los oprimidos había que hacer causa común, para afianzar el sistema opuesto a los intereses y hábitos de mando de los opresores. El tigre, espantado del fogonazo, vuelve de noche al lugar de la presa. Muere echando llamas por los ojos y con las zarpas al aire. No se le oye venir, sino que viene con zarpas de terciopelo. Cuando la presa despierta, tiene al tigre encima. La colonia continuó viviendo en la república; y nuestra América se está salvando de sus grandes yerros -de la soberbia de las ciudades capitales, del triunfo ciego de los campesinos desdeñados, de la importación excesiva de las ideas y fórmulas ajenas, del desdén inicuo e impolítico de la raza aborigen- por la virtud superior, abonada con sangre necesaria, de la república que lucha contra la colonia. El tigre espera, detrás de cada árbol, acurrucado en cada esquina. Morirá, con las zarpas al aire, echando llamas por los ojos.",
            "Pero \"estos países se salvarán\", como anunció Rivadavia el argentino, el que pecó de finura en tiempos crudos; al machete no le va vaina de seda, ni en el país que se ganó con lanzón se puede echar el lanzón atrás, porque se enoja, y se pone en la puerta del Congreso de Iturbide \"a que le hagan emperador al rubio\". Estos países se salvarán, porque, con el genio de la moderación que parece imperar, por la armonía serena de la Naturaleza, en el continente de la luz, y por el influjo de la lectura crítica que ha sucedido en Europa a la lectura de tanteo y falansterio en que se empapó la generación anterior, le está naciendo a América, en estos tiempos reales, el hombre real.",
            "Éramos una visión, con el pecho de atleta, las manos de petimetre y la frente de niño. Éramos una máscara, con los calzones de Inglaterra, el chaleco parisiense, el chaquetón de Norteamérica y la montera de España. El indio, mudo, nos daba vueltas alrededor, y se iba al monte, a la cumbre del monte, a bautizar a sus hijos. El negro, oteado, cantaba en la noche la música de su corazón, solo y desconocido, entre las olas y las fieras. El campesino, el creador, se revolvía, ciego de indignación, contra la ciudad desdeñosa, contra su criatura. Éramos charreteras y togas, en países que venían al mundo con la alpargata en los pies y la vincha en la cabeza. El genio hubiera estado en hermanar, con la caridad del corazón y con el atrevimiento de los fundadores, la vincha y la toga; en desestancar al indio; en ir haciendo lado al negro suficiente; en ajustar la libertad al cuerpo de los que se alzaron y vencieron por ella. Nos quedó el oidor, y el general, y el letrado, y el prebendado. La juventud angélica, como de los brazos de un pulpo, echaba al Cielo, para caer con gloria estéril, la cabeza coronada de nubes. El pueblo natural, con el empuje del instinto, arrollaba, ciego del triunfo, los bastones de oro. Ni el libro europeo, ni el libro yanqui, daban la clave del enigma hispanoamericano. Se probó el odio, y los países venían cada año a menos. Cansados del odio inútil, de la resistencia del libro contra la lanza, de la razón contra el cirial, de la ciudad contra el campo, del imperio imposible de las castas urbanas divididas sobre la nación natural, tempestuosa o inerte, se empieza, como sin saberlo, a probar el amor. Se ponen en pie los pueblos, y se saludan. \"¿Cómo somos?\" se preguntan; y unos a otros se van diciendo cómo son. Cuando aparece en Cojímar un problema, no van a buscar la solución a Danzig. Las levitas son todavía de Francia, pero el pensamiento empieza a ser de América. Los jóvenes de América se ponen la camisa al codo, hunden las manos en la masa y la levantan con la levadura de su sudor. Entienden que se imita demasiado, y que la salvación está en crear. Crear es la palabra de pase de esta generación. El vino, de plátano; y si sale agrio, ¡es nuestro vino! Se entiende que las formas de gobierno de un país han de acomodarse a sus elementos naturales; que las ideas absolutas, para no caer por un yerro de forma, han de ponerse en formas relativas; que la libertad, para ser viable, tiene que ser sincera y plena; que si la república no abre los brazos a todos y adelanta con todos, muere la república. El tigre de adentro se echa por la hendija, y el tigre de afuera. El general sujeta en la marcha la caballería al paso de los infantes. O si deja a la zaga a los infantes, le envuelve el enemigo la caballería. Estrategia es política. Los pueblos han de vivir criticándose, porque la crítica es la salud; pero con un solo pecho y una sola mente. ¡Bajarse hasta los infelices y alzarlos en los brazos! ¡Con el fuego del corazón deshelar la América coagulada! ¡Echar, bullendo y rebotando, por las venas, la sangre natural del país! En pie, con los ojos alegres de los trabajadores, se saludan, de un pueblo a otro, los hombres nuevos americanos. Surgen los estadistas naturales del estudio directo de la Naturaleza. Leen para aplicar, pero no para copiar. Los economistas estudian la dificultad en sus orígenes. Los oradores empiezan a ser sobrios. Los dramaturgos traen los caracteres nativos a la escena. Las academias discuten temas viables. La poesía se corta la melena zorrillesca y cuelga del árbol glorioso el chaleco colorado. La prosa, centelleante y cernida, va cargada de idea. Los gobernadores, en las repúblicas de indios, aprenden indio. De todos sus peligros se va salvando América. Sobre algunas repúblicas está durmiendo el pulpo. Otras, por la ley del equilibrio, se echan a pie a la mar, a recobrar, con prisa loca y sublime, los siglos perdidos. Otras, olvidando que Juárez paseaba en un coche de mulas, ponen coche de viento y de cochero a una pompa de jabón; el lujo venenoso, enemigo de la libertad, pudre al hombre liviano y abre la puerta al extranjero. Otras acendran, con el espíritu épico de la independencia amenazada, el carácter viril. Otras crían, en la guerra rapaz contra el vecino, la soldadesca que puede devorarlas. Pero otro peligro corre, acaso, nuestra América, que no le viene de sí, sino de la diferencia de orígenes, métodos e intereses entre los dos factores continentales, y es la hora próxima en que se le acerque, demandando relaciones íntimas, un pueblo emprendedor y pujante que la desconoce y la desdeña. Y como los pueblos viriles, que se han hecho de sí propios, con la escopeta y la ley, aman, y sólo aman, a los pueblos viriles; como la hora del desenfreno y la ambición, de que acaso se libre, por el predominio de lo más puro de su sangre, la América del Norte, o en que pudieran lanzarla sus masas vengativas y sórdidas, la tradición de conquista y el interés de un caudillo hábil, no está tan cercana aún a los ojos del más espantadizo, que no dé tiempo a la prueba de altivez, continua y discreta, con que se la pudiera encarar y desviarla. Como su decoro de república pone a la América del Norte, ante los pueblos atentos del Universo, un freno que no le ha de quitar la provocación pueril o la arrogancia ostentosa o la discordia parricida de nuestra América, el deber urgente de nuestra América es enseñarse cómo es, una en alma e intento, vencedora veloz de un pasado sofocante, manchada sólo con sangre de abono que arranca a las manos la pelea con las ruinas, y la de las venas que nos dejaron picadas nuestros dueños. El desdén del vecino formidable, que no la conoce, es el peligro mayor de nuestra América; y urge, porque el día de la visita está próximo, que el vecino la conozca, la conozca pronto, para que no la desdeñe. Por el respeto, luego que la conociese, sacaría de ella las manos. Se ha de tener fe en lo mejor del hombre y desconfiar de lo peor de él. Hay que dar ocasión a lo mejor para que se revele y prevalezca sobre lo peor. Si no, lo peor prevalece. Los pueblos han de tener una picota para quien les azuza a odios inútiles; y otra para quien no les dice a tiempo la verdad.",
            "No hay odio de razas, porque no hay razas. Los pensadores canijos, los pensadores de lámparas, enhebran y recalientan las razas de librería, que el viajero justo y el observador cordial buscan en vano en la justicia de la Naturaleza, donde resalta en el amor victorioso y el apetito turbulento, la identidad universal del hombre. El alma emana, igual y eterna, de los cuerpos diversos en forma y en color. Peca contra la Humanidad el que fomente y propague la oposición y el odio de las razas. Pero en el amasijo de los pueblos se condensan, en la cercanía de otros pueblos diversos, caracteres peculiares y activos, de ideas y de hábitos, de ensanche y adquisición, de vanidad y de avaricia, que del estado latente de preocupaciones nacionales pudieran, en un período de desorden interno o de precipitación del carácter acumulado del país, trocarse en amenaza grave para las tierras vecinas, aisladas y débiles, que el país fuerte declara perecederas e inferiores. Pensar es servir. Ni ha de suponerse, por antipatía de aldea, una maldad ingeníta y fatal al pueblo rubio del continente, porque no habla nuestro idioma, ni ve la casa como nosotros la vemos, ni se nos parece en sus lacras políticas, que son diferentes de las nuestras; ni tiene en mucho a los hombres biliosos y trigueños, ni mira caritativo, desde su eminencia aún mal segura, a los que, con menos favor de la Historia, suben a tramos heroicos la vía de las repúblicas. Ni se han de esconder los datos patentes del problema que puede resolverse, para la paz de los siglos, con el estudio oportuno y la unión tácita y urgente del alma continental. ¡Porque ya suena el himno unánime; la generación actual lleva a cuestas, por el camino abonado por los padres sublimes, la América trabajadora; del Bravo a Magallanes, sentado en el lomo del cóndor, regó el Gran Semí, por las naciones románticas del continente y por las islas dolorosas del mar, la semilla de la América nueva!"
            

          ]
        }
      };
      
      let currentLang = 'en';

      function toggleLanguage() {
        currentLang = currentLang === 'en' ? 'es' : 'en';
        updateUILanguage();
        updateContent();
        // Notes are now preserved through the updateContent function
      }

      function updateUILanguage() {
        // Update all UI elements
        document.getElementById('themeToggle').textContent = translations[currentLang].themeButton;
        document.getElementById('randomQuoteBtn').textContent = translations[currentLang].randomQuoteButton;
        document.getElementById('languageBtn').textContent = translations[currentLang].languageButton;
        
        // Update labels
        const highlightLabel = document.querySelector('label[for="highlightColor"]');
        if (highlightLabel) {
          highlightLabel.textContent = translations[currentLang].highlightLabel;
        }
        
        const noteLabel = document.querySelector('label[for="noteColor"]');
        if (noteLabel) {
          noteLabel.textContent = translations[currentLang].noteLabel;
        }
        
        // Update export button
        const exportBtn = document.querySelector('button[onclick="exportToPDF()"]');
        if (exportBtn) {
          exportBtn.textContent = translations[currentLang].exportButton;
        }

        // Update attribution
        const attribution = document.getElementById('attribution');
        if (attribution) {
          attribution.textContent = attribution.getAttribute(`data-${currentLang}`);
        }
      }

      function updateContent() {
        const paragraphs = document.querySelectorAll('article p:not(:last-child)');
        const storedHighlights = [];
    
        // Step 1: Store existing highlights with relative ratios
        document.querySelectorAll('.selected-text').forEach((highlight, index) => {
          const parent = highlight.closest('p');
          if (!parent) return;
      
          const paragraphText = parent.textContent;
          const startIndex = paragraphText.indexOf(highlight.textContent);
          if (startIndex === -1) return;
      
          storedHighlights.push({
              id: `highlight-${index}`, // Unique ID
              paragraphIndex: Array.from(paragraphs).indexOf(parent),
              originalText: highlight.textContent,
              ratio: startIndex / paragraphText.length,
              lengthRatio: highlight.textContent.length / paragraphText.length,
              backgroundColor: highlight.style.backgroundColor
          });
      });
    
        console.log("Stored relative highlights:", storedHighlights);
    
        // Step 2: Update paragraphs with new language content
        contentTranslations[currentLang].paragraphs.forEach((text, index) => {
            if (paragraphs[index]) {
                paragraphs[index].textContent = text;
            }
        });
    
        // Step 3: Reapply highlights with Levenshtein first, ratio fallback second
        storedHighlights.forEach(h => {
            const p = paragraphs[h.paragraphIndex];
            if (!p) return;
            const newText = p.textContent;
    
            // Attempt Levenshtein match first
            highlightBestMatch(h.originalText, h.backgroundColor, h.paragraphIndex);
    
            // Fallback to ratio-based method if Levenshtein fails
            // Fallback to ratio-based method if Levenshtein fails
if (!document.querySelector(`.selected-text[data-original-text="${h.originalText}"]`)) {
  console.warn(`Levenshtein failed, falling back to ratio method for: "${h.originalText}"`);
  const start = Math.floor(newText.length * h.ratio);
  const length = Math.floor(newText.length * h.lengthRatio);
  if (p.firstChild && p.firstChild.nodeType === Node.TEXT_NODE) {
    const range = document.createRange();
    try {
      range.setStart(p.firstChild, start);
      range.setEnd(p.firstChild, start + length);
      const span = document.createElement('span');
      span.className = 'selected-text';
      span.setAttribute('data-original-text', h.originalText);
      span.style.backgroundColor = h.backgroundColor;
      range.surroundContents(span);
    } catch (error) {
      console.error('Fallback highlighting error:', error);
    }
  }
}
        });
    
        // Update attribution text
        const attribution = document.getElementById('attribution');
        if (attribution) {
            attribution.textContent = attribution.getAttribute(`data-${currentLang}`);
        }
    }

    
function highlightBestMatch(translatedText, backgroundColor, paragraphIndex) {
    const paragraphs = document.querySelectorAll('article p:not(:last-child)');
    if (!paragraphs[paragraphIndex]) return;

    const paragraph = paragraphs[paragraphIndex];
    const text = paragraph.textContent;
    
    // Create a temporary container
    const temp = document.createElement('div');
    temp.innerHTML = text;
    
    // Find all matches
    const matches = [...text.matchAll(new RegExp(escapeRegExp(translatedText), 'gi'))];
    
    // Apply highlights in reverse order to maintain indices
    matches.reverse().forEach(match => {
        const range = document.createRange();
        range.setStart(paragraph.firstChild, match.index);
        range.setEnd(paragraph.firstChild, match.index + match[0].length);
        
        const span = document.createElement('span');
        span.className = 'selected-text';
        span.style.backgroundColor = backgroundColor;
        
        range.surroundContents(span);
    });
}

function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

  function applyHighlight(paragraph, startIndex, length, backgroundColor) {
    const paragraphText = paragraph.textContent;
    const before = paragraphText.substring(0, startIndex);
    const highlight = paragraphText.substring(startIndex, startIndex + length);
    const after = paragraphText.substring(startIndex + length);

    // Don't overwrite existing highlights
    if (paragraph.innerHTML.includes('selected-text')) {
        // Find position that doesn't overlap with existing highlights
        const existingHighlights = paragraph.querySelectorAll('.selected-text');
        let validPosition = true;
        existingHighlights.forEach(h => {
            const hStart = paragraphText.indexOf(h.textContent);
            const hEnd = hStart + h.textContent.length;
            if ((startIndex >= hStart && startIndex < hEnd) || 
                (startIndex + length > hStart && startIndex + length <= hEnd)) {
                validPosition = false;
            }
        });
        if (!validPosition) return;
    }

    const span = document.createElement('span');
    span.className = 'selected-text';
    span.style.backgroundColor = backgroundColor;
    span.textContent = highlight;

    paragraph.innerHTML = before + span.outerHTML + after;
}


function getLevenshteinSimilarity(str1, str2) {
  function levenshteinDistance(a, b) {
      const prevRow = Array(b.length + 1).fill(0).map((_, i) => i);
      let currentRow = Array(b.length + 1);

      for (let i = 1; i <= a.length; i++) {
          currentRow[0] = i;
          for (let j = 1; j <= b.length; j++) {
              const cost = a[i - 1] === b[j - 1] ? 0 : 1;
              currentRow[j] = Math.min(
                  currentRow[j - 1] + 1,      // Insertion
                  prevRow[j] + 1,             // Deletion
                  prevRow[j - 1] + cost       // Substitution
              );
          }
          prevRow.splice(0, prevRow.length, ...currentRow);
      }

      const distance = currentRow[b.length];
      const maxLength = Math.max(a.length, b.length);
      return (maxLength - distance) / maxLength;
  }

  return levenshteinDistance(str1, str2);
}


      // Global variables
      let annotationCounter = 1;
      let activeHighlightElem = null; // currently active highlighted span
      let activeStickyNote = null;    // currently active sticky note
      let userHighlightColor = '#ffeb3b';
      let userNoteColor = '#feff9c';
      let notes = [];
      let storedAnnotations = new Map(); // Store annotations for both languages
      let annotationMap = new Map(); // Stores annotations with translations

      // Basic page functionality
      document.addEventListener("DOMContentLoaded", () => {
          // Typewriter effect
          const titleText = "Nuestra América";
          const titleElem = document.getElementById("title");
          let charIndex = 0;
          
          function typeWriter() {
              if (charIndex < titleText.length) {
                  titleElem.innerHTML += titleText.charAt(charIndex);
                  charIndex++;
                  setTimeout(typeWriter, 150);
              }
          }
          typeWriter();

          // Initialize color pickers
          document.getElementById('highlightColor').addEventListener('input', function(e) {
              let color = e.target.value;
              if (activeHighlightElem) {
                  activeHighlightElem.style.backgroundColor = color;
              }
          });

          document.getElementById('noteColor').addEventListener('input', function(e) {
              let color = e.target.value;
              if (activeStickyNote) {
                  activeStickyNote.style.backgroundColor = color;
              }
          });
      });

      // Update the mouseup event to pass the mouse event to createStickyNote
      document.addEventListener('mouseup', function(e) {
        setTimeout(() => {
          const selectedText = window.getSelection().toString();
          // Only show the bar if there's a non-empty selection (and not within an input/textarea)
          if (selectedText.length > 0 && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
            showPostItBar(e, selectedText);
          } else {
            removePostItBar();
          }
        }, 50);
      });

      // Create an inline control bar to allow creation of a post-it.
      function showPostItBar(e, selectedText) {
        removePostItBar(); // remove any existing bar
        const bar = document.createElement('div');
        bar.id = 'postitBar';
        bar.style.position = 'absolute';
        bar.style.top = (e.pageY - 40) + 'px';
        bar.style.left = e.pageX + 'px';
        bar.style.background = '#fff';
        bar.style.border = '1px solid #ccc';
        bar.style.padding = '5px 10px';
        bar.style.borderRadius = '4px';
        bar.style.boxShadow = '0 2px 5px rgba(0,0,0,0.3)';
        bar.style.zIndex = 2000;
        
        const createBtn = document.createElement('button');
        createBtn.textContent = 'Create Post-it';
        createBtn.style.cursor = 'pointer';
        createBtn.addEventListener('click', function() {
            createStickyNote(selectedText, e);
            removePostItBar();
            window.getSelection().removeAllRanges();
        });
        bar.appendChild(createBtn);
        document.body.appendChild(bar);
      }

      function removePostItBar() {
        const existingBar = document.getElementById('postitBar');
        if (existingBar) {
            existingBar.remove();
        }
      }

      // Optionally, hide the bar if clicking elsewhere
      document.addEventListener('mousedown', function(e) {
        const bar = document.getElementById('postitBar');
        if (bar && !bar.contains(e.target)) {
            removePostItBar();
        }
      });

      // Draggable functionality
      function makeDraggable(element) {
          let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
          
          element.onmousedown = dragMouseDown;

          function dragMouseDown(e) {
              if (e.target.tagName === 'TEXTAREA') return;
              e.preventDefault();
              pos3 = e.clientX;
              pos4 = e.clientY;
              document.onmouseup = closeDragElement;
              document.onmousemove = elementDrag;
          }

          function elementDrag(e) {
              e.preventDefault();
              pos1 = pos3 - e.clientX;
              pos2 = pos4 - e.clientY;
              pos3 = e.clientX;
              pos4 = e.clientY;
              element.style.top = (element.offsetTop - pos2) + "px";
              element.style.left = (element.offsetLeft - pos1) + "px";
          }

          function closeDragElement() {
              document.onmouseup = null;
              document.onmousemove = null;
          }
      }

      // PDF Export: Re-read sticky note textarea values as annotations/footnotes
      function exportToPDF() {
        // Create a clone of the content to modify for PDF
        const content = document.querySelector('article').cloneNode(true);
        
        // Create a temporary container
        const pdfContainer = document.createElement('div');
        pdfContainer.style.padding = '20px';
        pdfContainer.style.background = '#ffffff';
        
        // Add title
        const title = document.createElement('h1');
        title.textContent = translations[currentLang].title;
        title.style.textAlign = 'center';
        title.style.color = '#000000';
        pdfContainer.appendChild(title);
        
        // Add main content
        pdfContainer.appendChild(content);
        
        // Add annotations section if there are any notes
        const notes = Array.from(document.querySelectorAll('.sticky-note'))
            .filter(note => note.querySelector('textarea').value.trim());
        
        if (notes.length > 0) {
            const annotationsTitle = document.createElement('h2');
            annotationsTitle.textContent = translations[currentLang].annotations;
            annotationsTitle.style.pageBreakBefore = 'always';
            annotationsTitle.style.color = '#000000';
            pdfContainer.appendChild(annotationsTitle);
            
            const annotationsList = document.createElement('div');
            notes.forEach(note => {
                const noteNumber = note.getAttribute('data-annotation');
                const noteText = note.querySelector('textarea').value.trim();
                const highlightedText = document.querySelector(
                    `.selected-text[data-annotation="${noteNumber}"]`
                )?.textContent || '';
                
                const noteElement = document.createElement('div');
                noteElement.style.marginBottom = '1em';
                noteElement.style.color = '#000000';
                noteElement.innerHTML = `
                    <strong>[${noteNumber}]</strong> "${highlightedText}"<br>
                    <em>${noteText}</em>
                `;
                annotationsList.appendChild(noteElement);
            });
            pdfContainer.appendChild(annotationsList);
        }
        
        // Configure PDF options
        const opt = {
            margin: [0.5, 0.5],
            filename: `nuestra-america-${currentLang}-annotated.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2,
                useCORS: true,
                letterRendering: true
            },
            jsPDF: { 
                unit: 'in', 
                format: 'letter', 
                orientation: 'portrait'
            }
        };
        
        // Generate PDF
        html2pdf()
            .set(opt)
            .from(pdfContainer)
            .save()
            .catch(err => {
                console.error('PDF generation failed:', err);
                alert('Failed to generate PDF. Please try again.');
            })
            .finally(() => {
                // Cleanup
                pdfContainer.remove();
            });
    }

      // Fix: Toggle dark theme when clicking the button
      document.getElementById('themeToggle').addEventListener('click', () => {
          document.body.classList.toggle('dark');
      });

      // Fix: Toggle dimming on paragraph click (when no text is selected)
      document.querySelectorAll('article p').forEach(para => {
          para.addEventListener('click', (e) => {
              // Only toggle if the user isn't selecting text
              if (window.getSelection().toString().trim().length === 0) {
                  para.classList.toggle('active-highlight');
              }
          });
      });

      // Create the overlay for dimming
      const overlay = document.createElement('div');
      overlay.className = 'overlay';
      document.body.appendChild(overlay);

      const paragraphs = document.querySelectorAll('article p');
      paragraphs.forEach(p => {
        // Create and append the close-highlight button
        const closeBtn = document.createElement('span');
        closeBtn.className = 'close-highlight';
        closeBtn.innerHTML = '×';
        p.appendChild(closeBtn);

        // Paragraph click: highlight only if no text is being selected
        p.addEventListener('click', (e) => {
          if (window.getSelection().toString().trim() !== "") return;

          // Remove highlight from all paragraphs
          paragraphs.forEach(para => {
            para.classList.remove('active-highlight');
            const btn = para.querySelector('.close-highlight');
            if (btn) btn.style.display = 'none';
          });

          // Highlight current paragraph, show its close button and show overlay
          p.classList.add('active-highlight');
          closeBtn.style.display = 'block';
          overlay.style.display = 'block';
        });

        // Close button click: remove highlight and hide overlay
        closeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          p.classList.remove('active-highlight');
          closeBtn.style.display = 'none';
          overlay.style.display = 'none';
        });
      });

      // Clicking on the overlay removes any active highlights
      overlay.addEventListener('click', () => {
        paragraphs.forEach(p => {
          p.classList.remove('active-highlight');
          const btn = p.querySelector('.close-highlight');
          if (btn) btn.style.display = 'none';
        });
        overlay.style.display = 'none';
      });

      document.getElementById('randomQuoteBtn').addEventListener('click', () => {
        // Get all paragraphs within the article (excluding the last attribution paragraph)
        const paragraphs = Array.from(document.querySelectorAll('article p')).filter(p => {
          return !p.hasAttribute('style'); // or add any logic to exclude non-content paragraphs
        });
        
        let allSentences = [];
        paragraphs.forEach(p => {
          // Split text into sentences using regex: ends with .,!, or ?
          const sentences = p.textContent.match(/[^\.!\?]+[\.!\?]+/g);
          if (sentences) {
            allSentences.push(...sentences);
          }
        });
        
        if (allSentences.length > 0) {
          // Use mathematical randomness to pick a sentence
          const randomIndex = Math.floor(Math.random() * allSentences.length);
          const selectedQuote = allSentences[randomIndex].trim();
          
          document.getElementById('quoteText').textContent = selectedQuote;
          document.getElementById('quoteModal').style.display = 'block';
        }
      });

      // Close modal when clicking on the close button in the modal
      document.querySelector('#quoteModal .close').addEventListener('click', () => {
        document.getElementById('quoteModal').style.display = 'none';
      });

      // (Optional) Hide modal if clicking outside the modal content
      window.addEventListener('click', (e) => {
        const modal = document.getElementById('quoteModal');
        if (e.target == modal) {
          modal.style.display = 'none';
        }
      });

      // Add these modified functions to your existing JavaScript code

      // 1. First, add this improved textMapping object
      const textMapping = {
        paragraphPairs: contentTranslations.en.paragraphs.map((enText, index) => ({
          en: enText,
          es: contentTranslations.es.paragraphs[index]
        }))
      };

      // 2. Replace the existing findMatchingTextInSpanish function
      function findMatchingTextInSpanish(selectedText, paragraphIndex, sourceLang) {
        const targetLang = sourceLang === 'en' ? 'es' : 'en';
        const sourceParagraph = contentTranslations[sourceLang].paragraphs[paragraphIndex];
        const targetParagraph = contentTranslations[targetLang].paragraphs[paragraphIndex];
        
        // Get sentence boundaries in both languages
        const sourceSentences = sourceParagraph.match(/[^.!?]+[.!?]+/g) || [];
        const targetSentences = targetParagraph.match(/[^.!?]+[.!?]+/g) || [];
        
        // Find which sentence contains our selected text
        let sourceSentenceIndex = -1;
        let selectedSentence = '';
        
        sourceSentences.forEach((sentence, index) => {
          if (sentence.includes(selectedText)) {
            sourceSentenceIndex = index;
            selectedSentence = sentence;
          }
        });
        
        if (sourceSentenceIndex === -1) return selectedText;
        
        // Get corresponding sentence in target language
        const targetSentence = targetSentences[sourceSentenceIndex];
        if (!targetSentence) return selectedText;
        
        // Count words in selected text
        const selectedWords = selectedText.trim().split(/\s+/);
        const selectedWordCount = selectedWords.length;
        
        // Find relative position within sentence
        const sentenceWords = selectedSentence.trim().split(/\s+/);
        const startWordIndex = sentenceWords.findIndex(word => 
          selectedText.includes(word)
        );
        
        if (startWordIndex === -1) return selectedText;
        
        // Get corresponding words in target sentence
        const targetWords = targetSentence.trim().split(/\s+/);
        const targetStartIndex = Math.floor(
          (startWordIndex / sentenceWords.length) * targetWords.length
        );
        
        // Extract equivalent number of words, respecting sentence boundaries
        const extractedWords = targetWords.slice(
          targetStartIndex,
          Math.min(targetStartIndex + selectedWordCount, targetWords.length)
        );
        
        return extractedWords.join(' ');
      }

      // 3. Replace the createStickyNote function with this version
      function createStickyNote(selectedText, event) {
        const currentAnnotation = annotationCounter;
        const parentParagraph = window.getSelection().anchorNode.parentElement;
        const paragraphIndex = Array.from(document.querySelectorAll('article p')).indexOf(parentParagraph);
        
        // Store annotation data with both language versions
        const translatedText = findMatchingTextInSpanish(selectedText, paragraphIndex, currentLang);
        
        annotationMap.set(currentAnnotation, {
          currentLang,
          paragraphIndex,
          texts: {
            [currentLang]: selectedText,
            [currentLang === 'en' ? 'es' : 'en']: translatedText
          },
          noteText: '',
          highlightColor: document.getElementById('highlightColor').value,
          noteColor: document.getElementById('noteColor').value,
          position: {
            left: event.pageX + 20,
            top: event.pageY - 20
          }
        });

        // Create the highlight
        const span = document.createElement('span');
        span.className = 'selected-text';
        span.setAttribute('data-annotation', currentAnnotation);
        span.setAttribute('data-paragraph', paragraphIndex);
        span.style.backgroundColor = document.getElementById('highlightColor').value;
        span.textContent = selectedText;
        
        // Add annotation number
        const annSup = document.createElement('span');
        annSup.className = 'annotation-number';
        annSup.textContent = `[${currentAnnotation}]`;
        annSup.style.cursor = 'pointer';
        annSup.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            const noteElem = document.querySelector(`.sticky-note[data-annotation="${currentAnnotation}"]`);
            if (noteElem) {
                // Show the note
                noteElem.style.display = 'block';
                
                // Bring to front
                const maxZ = Math.max(...Array.from(document.querySelectorAll('.sticky-note'))
                    .map(note => parseInt(getComputedStyle(note).zIndex) || 0));
                noteElem.style.zIndex = maxZ + 1;
                
                // Position within viewport
                const rect = noteElem.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                if (rect.right > viewportWidth) {
                    noteElem.style.left = `${viewportWidth - rect.width - 20}px`;
                }
                if (rect.bottom > viewportHeight) {
                    noteElem.style.top = `${viewportHeight - rect.height - 20}px`;
                }
            }
        };
        span.appendChild(annSup);

        // Replace selection with highlighted span
        const selection = window.getSelection();
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(span);
        selection.removeAllRanges();

        // Create sticky note
        const note = createStickyNoteElement(
          currentAnnotation,
          event.pageX + 20,
          event.pageY - 20,
          selectedText
        );

        annotationCounter++;
        return note;
      }

      // 4. Add this helper function for creating sticky notes
      function createStickyNoteElement(annotationId, left, top, selectedText) {
        const note = document.createElement('div');
        note.className = 'sticky-note';
        note.setAttribute('data-annotation', annotationId);
        note.style.left = `${left}px`;
        note.style.top = `${top}px`;
        note.style.backgroundColor = document.getElementById('noteColor').value;

        const textarea = document.createElement('textarea');
        textarea.value = '';
        
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '×';
        closeBtn.className = 'note-close';
        closeBtn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          const note = e.target.closest('.sticky-note');
          if (note) {
            note.style.display = 'none';
          }
        };

        const deletePairBtn = document.createElement('button');
        deletePairBtn.textContent = 'Delete Pair';
        deletePairBtn.style.cssText = 'position: absolute; bottom: 5px; left: 5px;';
        deletePairBtn.onclick = () => {
          const highlightSpan = document.querySelector(`span.selected-text[data-annotation="${annotationId}"]`);
          if (highlightSpan) {
            highlightSpan.replaceWith(document.createTextNode(selectedText));
          }
          annotationMap.delete(annotationId);
          note.remove();
        };

        note.appendChild(closeBtn);
        note.appendChild(textarea);
        note.appendChild(deletePairBtn);
        document.querySelector('.color-controls').insertAdjacentElement('afterend', note);
        
        makeDraggable(note);
        return note;
      }



